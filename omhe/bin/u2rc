#!/usr/bin/env python
import pycurl
import sys
from omhe.core.parseomhe import parseomhe
from omhe.core import upload2restcat


try:
    from omhe.core.settings import USERNAME, PASSWORD, SENDER, RECEIVER, SUBJECT, SEC_LEVEL, RESTCAT_SERVER
except:
    print "I couldn't find your settings.py.  Perhaps you need to create one?"
    print sys.exc_info()
    exit(1)


URL="%s/api/create/" % (RESTCAT_SERVER)
routing={
        'sndr':SENDER,
        'rcvr':RECEIVER,
        'subj': SUBJECT,
         'sec': SEC_LEVEL,
        }

if __name__ == "__main__":
    """
Accept a singe omhe string from the command line. Parse, then print
the resulting dict, then upload to RESTCat
"""
    try:
        userpass=sys.argv[1]
        omhe_str=sys.argv[2]
        out_file=sys.argv[3]
        
    except(IndexError):
        print "You must supply username, password, an omhe message, and an out file!"
        print "u2rc [user:pass] [omhe_message] [out.json]"
        exit(1)
        

    
    print "Input omhe string is: %s" % (omhe_str)
    
    try:
        """ Instantaiate an instance of the OMHE class"""
        o = parseomhe()
        """Parse it if valid, otherwise raise the appropriate error"""
        d=o.parse(omhe_str)
        """Send the OMHE dictonary to RESTCat"""
        result=upload2restcat.upload2restcat(d, userpass, out_file)
        print "HTTP Response Code=%s" % (result.getinfo(result.HTTP_CODE),)
        result.close()
        
    except():
        print "An unexpected error occured. Here is the post-mortem:"
        print sys.exc_info()